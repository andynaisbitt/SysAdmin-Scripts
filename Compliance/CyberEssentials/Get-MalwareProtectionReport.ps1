<#
.SYNOPSIS
Checks Windows Defender Antivirus status, signature age, real-time protection, tamper protection, and recent threats.
#>
param (
    [string[]]$ComputerName,
    [string]$ExportPath
)

# --- Load Core Get-Targets.ps1 ---
. (Join-Path -Path $PSScriptRoot -ChildPath "..\..\Core\Get-Targets.ps1")

try {
    $TargetComputers = Get-Targets -ComputerName $ComputerName
    if (-not $TargetComputers) {
        Write-Warning "No target computers found for checks. Exiting."
        return
    }

    $Result = foreach ($Computer in $TargetComputers) {
        Write-Verbose "Checking malware protection on $Computer..."
        try {
            Invoke-Command -ComputerName $Computer -ScriptBlock {
                $MpStatus = Get-MpComputerStatus -ErrorAction SilentlyContinue
                $MpPreference = Get-MpPreference -ErrorAction SilentlyContinue
                $MpThreats = Get-MpThreat -ErrorAction SilentlyContinue | Select-Object ThreatName, SeverityId, DetectionTime -First 5

                [PSCustomObject]@{
                    ComputerName            = $using:Computer
                    AntivirusEnabled        = if ($MpStatus) { $MpStatus.AntivirusEnabled } else { "N/A" }
                    RtpEnabled              = if ($MpStatus) { $MpStatus.RealTimeProtectionEnabled } else { "N/A" }
                    AntivirusSignatureVersion = if ($MpStatus) { $MpStatus.AntivirusSignatureVersion } else { "N/A" }
                    AntivirusSignatureAgeDays = if ($MpStatus) { (New-TimeSpan -Start $MpStatus.AntivirusSignatureLastUpdated).Days } else { "N/A" }
                    TamperProtection        = if ($MpPreference) { $MpPreference.TamperProtection } else { "N/A" }
                    LastFullScanDateTime    = if ($MpStatus) { $MpStatus.LastFullScanDateTime } else { "N/A" }
                    LastQuickScanDateTime   = if ($MpStatus) { $MpStatus.LastQuickScanDateTime } else { "N/A" }
                    RecentThreats           = if ($MpThreats) { ($MpThreats | ForEach-Object { "$($_.ThreatName) (Detected: $($_.DetectionTime))" }) -join "; " } else { "None" }
                }
            } -ErrorAction Stop
        }
        catch {
            Write-Warning "Failed to get malware protection status from '$Computer'. Error: $($_.Exception.Message)"
            [PSCustomObject]@{
                ComputerName            = $Computer
                AntivirusEnabled        = "Error"
                RtpEnabled              = "Error"
                AntivirusSignatureVersion = "Error"
                AntivirusSignatureAgeDays = "Error"
                TamperProtection        = "Error"
                LastFullScanDateTime    = "Error"
                LastQuickScanDateTime   = "Error"
                RecentThreats           = "Error"
                ErrorDetails            = $_.Exception.Message
            }
        }
    }

    if ($ExportPath) {
        if ($ExportPath.EndsWith(".csv")) {
            $Result | Export-Csv -Path $ExportPath -NoTypeInformation
        }
        elseif ($ExportPath.EndsWith(".html")) {
            $Result | ConvertTo-Html -Title "Malware Protection Report" | Out-File -Path $ExportPath
        }
        else {
            Write-Warning "Invalid export path. Please specify a .csv or .html file."
        }
    }
    else {
        $Result | Format-Table -AutoSize
    }
}
catch {
    Write-Error "An error occurred during malware protection report generation: $($_.Exception.Message)"
}
